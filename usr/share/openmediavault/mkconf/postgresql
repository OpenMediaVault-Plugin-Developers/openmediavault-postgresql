#!/bin/sh
#
# Copyright (C) 2010-2012 Ian Moore <imooreyahoo@gmail.com>
# Copyright (C) 2013-2015 OpenMediaVault Plugin Developers
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

POSTGRESQL_CONFIG="/etc/postgresql/9.1/main/postgresql.conf"
OMV_POSTGRESQL_PLUGIN_CONFIG=${OMV_POSTGRESQL_PLUGIN_CONFIG:-"/etc/postgresql/9.1/main/conf.d/openmediavault-postgresql.conf"}
OMV_POSTGRESQL_PLUGIN_XPATH="//services/postgresql"

detect_database_files()
{
    if [ ! -d "${1}" ]; then
        echo "Directory ${1} doesn't exist."

        return 1
    fi

    # Check for postgresql database files
    if [ ! -e "${1}/PG_VERSION" ]; then
        echo "Unable to find any database files in ${1}."

        return 3
    fi

    return 0
}

get_data_directory_from_config()
{
    cat "${1}" | grep data_directory | cut -d\' -f2
}

# Generate configuration only if the service is enabled.
if [ "$(omv_config_get "${OMV_POSTGRESQL_PLUGIN_XPATH}/enable")" != "1" ]; then
    exit 0
fi

# Get settings.
data_sharedfolderref=$(omv_config_get "${OMV_POSTGRESQL_PLUGIN_XPATH}/data.sharedfolderref")
data_directory="$(omv_get_sharedfolder_path "${data_sharedfolderref}")"

current_data_directory=""

# Get the current database location.
if [ -e "${OMV_POSTGRESQL_PLUGIN_CONFIG}" ]; then
    current_data_directory="$(get_data_directory_from_config ${OMV_POSTGRESQL_PLUGIN_CONFIG})"
else
    # If no openmediavault-postgresql configuration exists, use the standard
    # postgresql my.cnf file.
    if [ -e "${POSTGRESQL_CONFIG}" ]; then
        current_data_directory="$(get_data_directory_from_config ${POSTGRESQL_CONFIG})"
    else
        echo "Unable to get current database location."
        exit 2
    fi
fi

# Check if any database files exists in the current data directory.
if ! detect_database_files "${current_data_directory}" ; then
    if ! detect_database_files "${data_directory}" ; then
        exit 3
    else
        current_data_directory=${data_directory}
    fi
fi

# Generate the postgresql configuration.
xmlstarlet sel -t -m "${OMV_POSTGRESQL_PLUGIN_XPATH}" \
    -o "# This configuration file automatically generated by openmediavault-postgresql." -n \
    -o "# Changes to this file will be automatically overwritten." -n -n \
    -i "port != ''" -v "concat('port = ', port)" -n -b \
    -i "bind_address != ''" -v "concat('listen_addresses = ', bind_address)" -n -b \
    -o "data_directory = ${data_directory}" -n \
    -i "string-length(extra_options) > 0" -v "extra_options" -n -b \
    ${OMV_CONFIG_FILE} | xmlstarlet unesc > ${OMV_POSTGRESQL_PLUGIN_CONFIG}

# Set permissions on the configuration file.
chmod 644 ${OMV_POSTGRESQL_PLUGIN_CONFIG}

if [ "${current_data_directory}" != "${data_directory}" ]; then
    # If the choosen directory already has database files, move the current
    # ones. Otherwise use the existing files. This is useful if the user has
    # reinstalled and wants to reuse the old files.
    if ! detect_database_files "${data_directory}" ; then
        # Copy current data to the new directory and remove all files from the
        # old directory (but not the directory itself).
        cp -rfp ${current_data_directory}/* ${data_directory}/
        rm -rf ${current_data_directory}/*
    fi

    # Take ownership of the shared folder.
    chown -R postgres:postgres "${data_directory}"
fi

exit 0
